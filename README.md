local_garage
============

Railsアプリをherokuにあげるまで。

公式ドキュメント
https://devcenter.heroku.com/articles/rails4
https://devcenter.heroku.com/articles/getting-started-with-rails4


herokuのアカウントなどの登録を終了している前提。

まずはローカルからheroku-command line clientに接続する環境をつくるためにHeroku Toolbeltをインストールします。インストールが終わったら
$ heroku login
でターミナルから接続してみます。sshキーは  ~/.sshにあるパブリックキーがデフォルトで設定されますが、heroku用に生成して設定することもできます。


Railsアプリにおいて、ローカルではsqlite3がデフォルトで動いてるんですが、Herokuではsqlite3が動きません。公式ドキュメントにもある通り、開発と製品のデータベース環境は一致させる方がよいらしいので、ローカル環境にもpostgresを利用できる環境をつくります。


gemファイルの編集

(静的アセットのservingとlogging on Herokuのためにいれておく)
gem 'rails_12factor', group: :production

gem ‘sqlite3’
を削除して
gem ‘pg’
を追加する

ruby ‘使用しているバージョン’
を追加する

最終的なgemfile

source 'https://rubygems.org'

# Heroku Setting
gem 'rails_12factor',  group: :production
ruby '2.0.0'
gem 'foreman'
gem 'unicorn'
# Bundle edge Rails instead: gem 'rails', github: 'rails/rails'
gem 'rails', '4.1.6'
# Use sqlite3 as the database for Active Record
gem 'pg'
# Use SCSS for stylesheets
gem 'sass-rails', '~> 4.0.3'
# Use Uglifier as compressor for JavaScript assets
gem 'uglifier', '>= 1.3.0'
# Use CoffeeScript for .js.coffee assets and views
gem 'coffee-rails', '~> 4.0.0'
# See https://github.com/sstephenson/execjs#readme for more supported runtimes
# gem 'therubyracer',  platforms: :ruby

# Use jquery as the JavaScript library
gem 'jquery-rails'
# Turbolinks makes following links in your web application faster. Read more: https://github.com/rails/turbolinks
gem 'jquery-turbolinks'
gem 'turbolinks'

# Build JSON APIs with ease. Read more: https://github.com/rails/jbuilder
gem 'jbuilder', '~> 2.0'
# bundle exec rake doc:rails generates the API under doc/api.
gem 'sdoc', '~> 0.4.0',          group: :doc

# Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring
gem 'spring',        group: :development

# Use ActiveModel has_secure_password
gem 'bcrypt', '~> 3.1.7'
gem 'devise'
gem 'cancancan'


# form helper
gem 'enum_help'

gem 'therubyracer'
gem 'less-rails'
gem 'twitter-bootswatch-rails',  '~> 3.1.1'
gem 'twitter-bootswatch-rails-helpers'
# Use unicorn as the app server
# gem 'unicorn'

# Use Capistrano for deployment
# gem 'capistrano-rails', group: :development

# Use debugger
# gem 'debugger', group: [:development, :test]

gem "gmaps4rails"
gem "geocoder"

gem "websocket-rails"
gem 'tzinfo-data', platforms: [:mingw, :mswin]

#database seed handling
gem 'seed-fu', '~> 2.3'




はじめからアプリを作成する場合は以下のように
$ rails new myapp --database=postgresql
使用するデータベースを指定してあげればいい。

既にあるアプリケーションのデータベース設定をマニュアルで変更する方法。
config/database.ymlの編集

アダプターをsplite3からpostgresqlに変更
productionはデータベースの情報を追加
例えば
production:
  adapter: postgresql
  encoding: utf8
  database: your_database
  port: 5432
  username: your_username
  password: your_password
こんな感じ


あとはgitリポジトリを作成して、add . commitをする
herokuのリモートリポジトリを
$ heroku create
で作成して、
$ git push heroku masterでプッシュします。

pushでエラーが出た場合は一つ一つつぶします。

僕の場合は
gem関係のエラーがまずでてきました。
splite3に依存しているgemがあるのでpushできないとかいわれるので、
そのときはGemfile.lockの中のsplite3関連の項目を削除してください。
 
.DS_storeがpushできないというエラーは
gitignoreファイルに.DS_storeをかけばOKです。

<gitignore>
# See https://help.github.com/articles/ignoring-files for more about ignoring files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile '~/.gitignore_global'

# Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

## generic files to ignore
*~
*.DS_Store


一番こまったのはコレ。
http://zirosas.wordpress.com/2013/06/02/twitter-bootstrap-for-rails/


config/application.rbに

config.assets.initialize_on_precompile = false
（rails4 では必要ないらしい）

を追加

config/environment/production.rbに

config.assets.compile = true

を追加する。
git add . 
git commitしてから

$ rake assets:precompile
$ git push heroku master


で通ります。
precompileしてからじゃないとデータベースにつなげないからかな？と推測しますが、よくわからん。

pushできたら

$ heroku run rake db:migrate
です。
ここでマイグレーションファイルのエラーがどっさり出ました。
整理しました。
レポジトリのファイルは
$ git rm <file>
で削除できるので、ちゃんと丁寧に整理していくと
$ heroku run rake db:migrateが通ります。

＊ちゃんときれいにマイグレーションファイルを整理してからpushするべき。

最後にWebサーバの設定をします。
railsではWebrickというサーバがデフォルトで動いています。テストには十分ですが、製品用のサーバーを設定したほうがいいとのことなので、UnicomというWebサーバを設定します。

Gemfileに
gem ‘unicorn’
を追加します。

config/unicorn.rbを新しく作って
worker_processes Integer(ENV["WEB_CONCURRENCY"] || 3)
timeout 15
preload_app true

before_fork do |server, worker|
  Signal.trap 'TERM' do
    puts 'Unicorn master intercepting TERM and sending myself QUIT instead'
    Process.kill 'QUIT', Process.pid
  end

  defined?(ActiveRecord::Base) and
    ActiveRecord::Base.connection.disconnect!
end

after_fork do |server, worker|
  Signal.trap 'TERM' do
    puts 'Unicorn worker intercepting TERM and doing nothing. Wait for master to send QUIT'
  end

  defined?(ActiveRecord::Base) and
    ActiveRecord::Base.establish_connection
end


このあとprocfileの設定などを行っていきます。
https://devcenter.heroku.com/articles/getting-started-with-rails4


ルードディレクトリでprocfileを作成して
web: bundle exec unicorn -p $PORT -c ./config/unicorn.rb
を追加します。

Foremanをつかったlocalでのunicornのテストなどを行います。

これで一通りの設定は終わりです。
